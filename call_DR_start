- task: AzureCLI@2
  displayName: "DR Start - Record Timestamp"
  inputs:
    azureSubscription: 'ado-uami-service-connection'
    scriptType: 'ps'
    scriptLocation: 'scriptPath'
    scriptPath: 'pilot-light-dmart/templates/scripts/push-dr-event.ps1'
    arguments: >
      -StorageAccountName drstorageprod
      -AppName "mock-python-app"
      -PrimaryRegion "centralindia"
      -SecondaryRegion "southindia"
      -RunType "DR"
      -Stage "Start"
      -Status "Started"
      -PipelineRunId "$(Build.BuildId)"

- script: |
    echo "Cleaning Terraform cache"
    rm -rf .terraform
    rm -rf ~/.terraform.d
  displayName: "Clean Terraform cache"

- task: AzureCLI@2
  displayName: "DR Chaos Test - Stop App Service"
  inputs:
    azureSubscription: ''
    scriptType: 'pscore'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az extension add --name chaos

      az chaos experiment start `
        --resource-group rg-chaos-dr `
        --name chaos-stop-appservice-dr

- task: PowerShell@2
  displayName: "Wait during Chaos Fault"
  inputs:
    targetType: 'inline'
    script: |
      Start-Sleep -Seconds 300



